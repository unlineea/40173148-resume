<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin - Requests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <header class="topbar">
    <div class="topbar__inner">
      <div class="brand">
        <span class="brand__dot" aria-hidden="true"></span>
        <span>Admin Console</span>
      </div>
      <nav class="nav" aria-label="Primary">
        <a href="/">Resume</a>
        <a href="/request">Request a Project</a>
        <a href="/admin/requests" aria-current="page">Requests</a>
        <button id="logout" class="btn btn-ghost" type="button">Logout</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <div class="grid">
      <section class="card">
        <div class="card__inner">
          <div class="row" style="align-items:center">
            <div>
              <h1 class="card__title" style="margin-bottom:6px">Project Requests</h1>
              <p class="card__subtitle" style="margin-bottom:0">Newest requests appear first.</p>
            </div>
            <span class="badge" style="justify-self:flex-end">
              <span class="badge__dot" aria-hidden="true"></span>
              Online: <strong id="online-count">0</strong>
            </span>
          </div>
          <div class="divider"></div>
          <section id="requests"></section>
        </div>
      </section>

      <aside class="card card--soft">
        <div class="card__inner">
          <h2 class="card__title">Actions</h2>
          <p class="card__subtitle">Quick admin tools.</p>
          <div class="divider"></div>
          <div class="row">
            <button class="btn btn-primary" type="button" id="refresh">Refresh</button>
            <a class="btn btn-ghost" href="/admin/login">Re-login</a>
          </div>
          <div class="divider"></div>
          <p class="card__subtitle" style="margin-bottom:0">
            If you see 401/403, your token expired—log in again.
          </p>
        </div>
      </aside>
    </div>
  </main>

  <footer class="footer">
    Admin view is protected by a JWT bearer token.
  </footer>

  <script>
    function renderRequests(list) {
      const container = document.getElementById('requests');
      if (!list.length) {
        container.innerHTML = '<div class="status">No requests yet.</div>';
        return;
      }
      container.innerHTML = `
        <div class="list">
          ${list.map(r => {
            const created = new Date(r.created_at).toLocaleString();
            const safeDesc = (r.description ?? '').replaceAll('<','&lt;').replaceAll('>','&gt;');
            const safeNotes = (r.admin_notes ?? '').replaceAll('<','&lt;').replaceAll('>','&gt;');
            const status = r.status || 'new';
            const statusClass = {
              new: 'status-pill--new',
              in_review: 'status-pill--in_review',
              in_progress: 'status-pill--in_progress',
              done: 'status-pill--done',
              archived: 'status-pill--archived'
            }[status] || 'status-pill--new';
            return `
              <article class="req req--collapsed" data-id="${r.id}">
                <div class="req__top">
                  <div class="req__name">
                    ${r.name}
                    <span class="req__meta">• ${r.email}</span>
                    <span class="req__chevron" aria-hidden="true">▾</span>
                  </div>
                  <div style="display:flex;gap:8px;align-items:center;">
                    <span class="status-pill ${statusClass}">
                      <span class="status-pill__dot"></span>
                      ${status.replace('_',' ')}
                    </span>
                    <span class="req__meta">${created}</span>
                  </div>
                </div>
                <div class="req__body">
                  <p class="req__desc">${safeDesc}</p>
                  <div class="divider"></div>
                  <div class="row">
                    <div class="field">
                      <div class="label">Status</div>
                      <select class="req-status">
                        ${['new','in_review','in_progress','done','archived'].map(s => `
                          <option value="${s}" ${status === s ? 'selected' : ''}>${s.replace('_',' ')}</option>
                        `).join('')}
                      </select>
                    </div>
                    <div class="field">
                      <div class="label">Admin notes</div>
                      <textarea class="req-notes" rows="2" placeholder="Internal notes…">${safeNotes}</textarea>
                    </div>
                  </div>
                  <div class="row" style="margin-top:10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-ghost req-delete">Delete</button>
                    <button type="button" class="btn btn-primary req-save">Save</button>
                  </div>
                </div>
              </article>
            `;
          }).join('')}
        </div>
      `;
    }

    async function loadRequests() {
      const token = localStorage.getItem('admin_token');
      if (!token) {
        window.location.href = '/admin/login';
        return;
      }
      try {
        document.getElementById('requests').innerHTML = '<div class="status">Loading…</div>';
        const res = await fetch('/api/admin/requests', {
          headers: { Authorization: 'Bearer ' + token }
        });
        if (res.status === 401 || res.status === 403) {
          localStorage.removeItem('admin_token');
          window.location.href = '/admin/login';
          return;
        }
        const json = await res.json();
        renderRequests(json);
      } catch (err) {
        document.getElementById('requests').innerHTML = '<div class="status status--bad">Failed to load</div>';
      }
    }

    document.getElementById('logout').addEventListener('click', () => {
      localStorage.removeItem('admin_token');
      window.location.href = '/admin/login';
    });

    document.getElementById('refresh').addEventListener('click', () => {
      loadRequests();
    });

    // delegation for per-request actions
    document.getElementById('requests').addEventListener('click', async (e) => {
      const target = e.target;
      const article = target.closest('.req');
      if (!article) return;

      // expand / collapse when clicking header area
      if (target.closest('.req__top')) {
        article.classList.toggle('req--collapsed');
        return;
      }

      const id = article.getAttribute('data-id');
      if (!id) return;

      const token = localStorage.getItem('admin_token');
      if (!token) {
        window.location.href = '/admin/login';
        return;
      }

      if (target.classList.contains('req-save')) {
        const statusEl = article.querySelector('.req-status');
        const notesEl = article.querySelector('.req-notes');
        const payload = {
          status: statusEl ? statusEl.value : undefined,
          admin_notes: notesEl ? notesEl.value : undefined
        };
        try {
          const res = await fetch(`/api/admin/requests/${id}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              Authorization: 'Bearer ' + token
            },
            body: JSON.stringify(payload)
          });
          if (res.status === 401 || res.status === 403) {
            localStorage.removeItem('admin_token');
            window.location.href = '/admin/login';
            return;
          }
          if (!res.ok) {
            alert('Failed to save changes');
            return;
          }
          // re-sync data from server
          loadRequests();
        } catch (err) {
          alert('Error saving changes');
        }
      }

      if (target.classList.contains('req-delete')) {
        if (!confirm('Delete this request? This cannot be undone.')) return;
        try {
          const res = await fetch(`/api/admin/requests/${id}`, {
            method: 'DELETE',
            headers: {
              Authorization: 'Bearer ' + token
            }
          });
          if (res.status === 401 || res.status === 403) {
            localStorage.removeItem('admin_token');
            window.location.href = '/admin/login';
            return;
          }
          if (res.status !== 204) {
            alert('Failed to delete');
            return;
          }
          // remove from UI without full reload
          article.remove();
          if (!document.querySelector('.req')) {
            document.getElementById('requests').innerHTML = '<div class="status">No requests yet.</div>';
          }
        } catch (err) {
          alert('Error deleting request');
        }
      }
    });

    loadRequests();
    // websocket for online count
    const ws = new WebSocket((location.protocol === "https:" ? "wss" : "ws") + "://" + location.host + "/ws/online");
    const countEl = document.getElementById("online-count");
    ws.onmessage = (evt) => {
      try {
        const data = JSON.parse(evt.data);
        if (data && typeof data.online === "number") {
          countEl.innerText = data.online;
        }
      } catch (e) { }
    };
    setInterval(() => { if (ws.readyState === WebSocket.OPEN) ws.send("ping"); }, 20000);
  </script>
</body>
</html>